// stylelint-disable primer/typography, primer/borders, primer/spacing, primer/box-shadow, max-nesting-depth

// group label, field, caption and error message
.FormGroup {
  display: inline-flex;
  flex-direction: column;
  gap: var(--base-size-4, 4px);
}

// fill container
.FormGroup--fullWidth {
  display: flex;
}

// <label>
.FormControl-label {
  color: var(--color-fg-default);
  font-size: var(--primer-text-body-size-medium, 14px);
  font-weight: var(--base-text-weight-semibold, 600);
  line-height: var(--primer-text-body-lineHeight-medium, 20px);
  user-select: none;
}

// optional caption
.FormControl-caption {
  margin-bottom: 0;
  font-size: var(--primer-text-caption-size, 12px);
  font-weight: var(--primer-text-caption-weight, 400);
  line-height: var(--primer-text-caption-lineHeight, 16px);
  color: var(--color-fg-muted);
}

.FormControl-validation {
  display: flex;
  font-size: var(--primer-text-caption-size, 12px);
  font-weight: var(--base-text-weight-semibold, 600);
  color: var(--color-danger-fg);
  fill: var(--color-danger-fg);
  flex-direction: row;
  align-items: center;
  gap: var(--base-size-4, 4px);

  // stylelint-disable-next-line selector-max-type
  p {
    margin-bottom: 0;
  }
}

// shared among all form control components (input, select, textarea, checkbox, radio)
.FormControl {
  background-color: var(--color-canvas-default);
  border: solid var(--primer-borderWidth-thin, 1px) var(--color-border-default);

  &:not([type='radio']):not([type='checkbox'])[disabled] {
    color: var(--color-primer-fg-disabled);
    background-color: var(--color-input-disabled-bg);
    border-color: var(--color-border-default);
    -webkit-text-fill-color: var(--color-primer-fg-disabled);
    opacity: 1;
    cursor: not-allowed;
  }

  &:not(:focus)[invalid] {
    border-color: var(--color-danger-emphasis);
  }

  &:focus {
    @include focusBoxShadowInset;

    // remove fallback :focus if :focus-visible is supported
    &:not(:focus-visible) {
      border-color: transparent;

      @include focusBoxShadowInset(1px, transparent);
    }
  }

  // default focus state
  &:focus-visible {
    @include focusBoxShadowInset;
  }

  &.FormControl--inset {
    background-color: var(--color-canvas-inset);
  }

  &.FormControl--monospace {
    font-family: var(
      --primer-fontStack-monospace,
      'ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace'
    );
  }

  // <select> and <input>
  &.FormControl--input,
  &.FormControl--select {
    height: var(--primer-control-medium-size, 32px);
    font-size: var(--primer-text-body-size-medium, 14px);
    line-height: var(--primer-text-body-lineHeight-medium, 20px);
    border-radius: var(--primer-borderRadius-medium, 6px);
    padding-inline: var(--primer-control-medium-paddingInline-condensed, 8px);
    transition: 80ms cubic-bezier(0.33, 1, 0.68, 1);
    transition-property: color, background-color, box-shadow, border-color;
    padding-block: calc(var(--primer-control-medium-paddingBlock, 6px) - var(--primer-borderWidth-thin, 1px));
    width: 100%;

    &[disabled] {
      &::placeholder {
        color: var(--color-primer-fg-disabled);
      }
    }

    ::placeholder {
      color: var(--color-fg-subtle);
      opacity: 1;
    }
  }

  // sizes

  &.FormControl--small {
    height: var(--primer-control-small-size, 28px);
    padding-inline: var(--primer-control-small-paddingInline-normal, 8px);
    padding-block: var(--primer-control-small-paddingBlock, 4px);
    font-size: var(--primer-text-body-size-small, 12px);
  }

  &.FormControl--medium {
    height: var(--primer-control-medium-size, 32px);
  }

  &.FormControl--large {
    height: var(--primer-control-large-size, 40px);
    padding-inline: var(--primer-control-large-paddingInline-normal, 12px);
    padding-block: var(--primer-control-large-paddingBlock, 10px);
  }
}

// positioning for leading/trailing items
.FormControl-fieldWrap {
  display: grid;
  position: relative;

  .FormControl--input-leadingVisualWrap {
    position: absolute;
    display: block;
    width: var(--base-size-16, 16px);
    height: var(--base-size-16, 16px);
    top: var(--base-size-8, 8px);
    left: var(--base-size-8, 8px);
    color: var(--color-fg-muted);
    pointer-events: none;

    // octicon
    .FormControl--input-leadingVisual {
      display: block;
      user-select: none;
    }
  }

  // TODO: replace with new Button component
  .FormControl--input-trailingAction {
    display: grid;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: var(--base-size-4, 4px);
    right: var(--base-size-4, 4px);
    z-index: 4;
    width: var(--primer-control-xsmall-size, 24px);
    height: var(--primer-control-xsmall-size, 24px);
    padding: 0;
    border: none;
    border-radius: var(--primer-borderRadius-small);
    background: transparent;
    color: var(--color-fg-muted);
    cursor: pointer;
    transition: 0.2s cubic-bezier(0.3, 0, 0.5, 1);
    transition-property: color, background-color, border-color;

    svg {
      user-select: none;
    }

    &[disabled] {
      color: var(--color-primer-fg-disabled);
      pointer-events: none;
    }

    &:hover {
      background: var(--color-action-list-item-default-hover-bg);
    }

    &:active {
      background: var(--color-action-list-item-default-active-bg);
    }

    // show vertical divider line between field and button
    &:before {
      content: '';
      display: block;
      position: absolute;
      top: calc((var(--primer-control-xsmall-size) - var(--base-size-16)) / 2);
      left: calc(var(--base-size-4, 4px) * -1);
      width: var(--primer-borderWidth-thin);
      height: var(--base-size-16);
      background: var(--color-border-default);
    }

    &:after {
      @include minTouchTarget(var(--primer-control-medium-size), var(--primer-control-medium-size));

      @media (pointer: coarse) {
        min-width: var(--primer-control-minTarget-coarse);
        min-height: var(--primer-control-minTarget-coarse);
      }
    }
  }

  // if leadingVisual is present
  &.FormControl-fieldWrap--input-leadingVisual {
    .FormControl--input {
      padding-inline-start: calc(
        var(--primer-control-medium-paddingInline-condensed, 8px) + var(--base-size-16, 16px) +
          var(--primer-control-medium-gap, 8px) - var(--primer-borderWidth-thin, 1px)
      );
    }
  }

  // if trailingAction is present
  &.FormControl-fieldWrap--input-trailingAction {
    .FormControl--input {
      padding-inline-end: calc(
        var(--primer-control-medium-paddingInline-condensed, 8px) + var(--base-size-16, 16px) +
          var(--primer-control-medium-gap, 8px) - var(--primer-borderWidth-thin, 1px)
      );
    }
  }

  // size modifications can be refactored with :has() - FormControl-fieldWrap:has(.FormControl--large)
  // sizes
  &.FormControl-fieldWrap--input {
    &.FormControl--small {
      .FormControl--input-leadingVisualWrap {
        top: calc(var(--primer-control-medium-paddingInline-condensed, 8px) - 0.125rem); /* 6px */
        left: calc(var(--primer-control-medium-paddingInline-condensed, 8px) - 0.125rem); /* 6px */
      }

      &.FormControl-fieldWrap--input-trailingAction {
        .FormControl--input.FormControl--small {
          padding-inline-end: calc(
            var(----primer-control-small-paddingInline-condensed, 8px) + var(--base-size-16, 16px) +
              var(--primer-control-small-gap, 8px) - var(--primer-borderWidth-thin, 1px)
          ); /* 27px */
        }
      }

      .FormControl--input-trailingAction {
        width: calc(var(--primer-control-small-size, 28px) - var(--base-size-8, 8px));
        height: calc(var(--primer-control-small-size, 28px) - var(--base-size-8, 8px));

        &:before {
          top: calc((var(--primer-control-xsmall-size) - var(--base-size-16)) / 4); /* 2px */
        }
      }
    }

    &.FormControl--large {
      .FormControl--input-leadingVisualWrap {
        top: var(--primer-control-medium-paddingInline-normal, 12px);
        left: var(--primer-control-medium-paddingInline-normal, 12px);
      }

      &.FormControl-fieldWrap--input-leadingVisual {
        .FormControl--input.FormControl--large {
          padding-inline-start: calc(
            var(--primer-control-large-paddingInline-normal, 12px) + var(--base-size-16, 16px) +
              var(--primer-control-large-gap, 8px) - var(--primer-borderWidth-thin, 1px)
          ); /* 31px */
        }
      }

      &.FormControl-fieldWrap--input-trailingAction {
        .FormControl--input.FormControl--large {
          padding-inline-end: calc(
            var(--primer-control-large-paddingInline-normal, 12px) + var(--base-size-16, 16px) +
              var(--primer-control-large-gap, 8px)
          ); /* 36px */
        }
      }

      .FormControl--input-trailingAction {
        width: var(--primer-control-small-size, 28px);
        height: var(--primer-control-small-size, 28px);
        top: calc(var(--primer-control-medium-paddingInline-condensed, 8px) - 0.125rem); /* 6px */
        right: calc(var(--primer-control-medium-paddingInline-condensed, 8px) - 0.125rem); /* 6px */

        &:before {
          height: var(--base-size-20);
          top: unset;
        }
      }
    }
  }
}

.FormControl-fieldWrap--select {
  grid-template-columns: minmax(0, auto) var(--base-size-16, 16px);

  // mask allows for background-color to respect themes
  &::after {
    width: var(--base-size-16, 16px);
    height: var(--base-size-16, 16px);
    padding-right: var(--base-size-4, 4px);
    pointer-events: none;
    content: '';
    background-color: var(--color-fg-muted);
    mask: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0iIzU4NjA2OSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNC40MjcgOS40MjdsMy4zOTYgMy4zOTZhLjI1MS4yNTEgMCAwMC4zNTQgMGwzLjM5Ni0zLjM5NkEuMjUuMjUgMCAwMDExLjM5NiA5SDQuNjA0YS4yNS4yNSAwIDAwLS4xNzcuNDI3ek00LjQyMyA2LjQ3TDcuODIgMy4wNzJhLjI1LjI1IDAgMDEuMzU0IDBMMTEuNTcgNi40N2EuMjUuMjUgMCAwMS0uMTc3LjQyN0g0LjZhLjI1LjI1IDAgMDEtLjE3Ny0uNDI3eiIgLz48L3N2Zz4=');
    mask-size: contain;
    grid-column: 2;
    grid-row: 1;
    place-self: center end;
  }

  // spans entire grid below mask
  .FormControl {
    grid-column: 1/-1;
    grid-row: 1;
    appearance: none;
    padding-right: var(--base-size-20, 20px);
  }
}

.FormGroup--checkbox {
  display: inline-grid;
  grid-template-areas: 'field label' '. caption';
  gap: var(--base-size-8, 8px);

  .FormControl--checkbox-labelWrap {
    display: flex;
    flex-direction: column;
    gap: var(--base-size-4, 4px);
  }

  .FormControl-label {
    grid-area: label;
  }

  .FormControl-caption {
    grid-area: caption;
  }
}

// checkbox + radio specific styles

.FormControl--checkbox,
.FormControl--radio {
  position: absolute;
  width: var(--base-size-16, 16px);
  height: var(--base-size-16, 16px);
  opacity: 0;

  &:focus-visible {
    + .FormControl--checkbox-svg,
    + .FormControl--radio-svg {
      .FormControl--checkbox-background,
      .FormControl--radio-background {
        stroke: var(--color-accent-fg);
        border-radius: 4px;
        position: relative;
      }
    }
  }

  &[disabled] {
    cursor: not-allowed;
    + .FormControl--checkbox-svg,
    + .FormControl--radio-svg {
      .FormControl--checkbox-background,
      .FormControl--radio-background {
        fill: var(--color-input-disabled-bg);
        stroke: var(--color-border-default);
      }
    }
  }

  &:checked {
    &:focus-visible {
      + .FormControl--checkbox-svg,
      + .FormControl--radio-svg {
        overflow: visible;
        .FormControl--checkbox-background,
        .FormControl--radio-background {
          outline: 1px solid var(--color-accent-fg);
          outline-offset: 2px;
        }
      }
    }
    + .FormControl--checkbox-svg,
    + .FormControl--radio-svg {
      .FormControl--checkbox-background,
      .FormControl--radio-background {
        fill: var(--color-accent-fg);
        stroke: var(--color-accent-fg);
        transition: all 80ms cubic-bezier(0.3, 0, 0.5, 1);
      }

      .FormControl--radio-circle {
        visibility: visible;
        transition: visibility 0s linear 0s;

        @media screen and (prefers-reduced-motion: no-preference) {
          animation: radioIn 240ms cubic-bezier(0.65, 0, 0.35, 1) forwards 80ms;
        }
      }

      .FormControl--checkbox-check {
        visibility: visible;
        transition: visibility 0s linear 0s;

        @media screen and (prefers-reduced-motion: no-preference) {
          animation: checkmarkIn 240ms cubic-bezier(0.65, 0, 0.35, 1) forwards 80ms;
        }
      }
    }
  }

  &:indeterminate {
    + .FormControl--checkbox-svg {
      .FormControl--checkbox-background {
        fill: var(--color-accent-fg);
        stroke: var(--color-accent-fg);
      }

      .FormControl--checkbox-indeterminate {
        fill: var(--color-fg-on-emphasis);
        visibility: visible;
      }
    }
  }
}

.FormControl--checkbox-svg,
.FormControl--radio-svg {
  width: var(--base-size-16, 16px);
  height: var(--base-size-16, 16px);
  margin-top: 0.125rem;
  cursor: pointer;

  .FormControl--checkbox-background,
  .FormControl--radio-background {
    fill: var(--color-canvas-default);
    stroke: var(--color-border-default);
    transition: all 0ms cubic-bezier(0.65, 0, 0.35, 1) 230ms;
  }

  .FormControl--radio-circle {
    visibility: hidden;
    fill: var(--color-fg-on-emphasis);
    transition: visibility 0s linear 230ms;
    clip-path: circle(0%);

    @media screen and (prefers-reduced-motion: no-preference) {
      animation: radioOut 220ms cubic-bezier(0.65, 0, 0.35, 1) forwards; // slightly snappier animation out
    }
  }

  .FormControl--checkbox-check {
    visibility: hidden;
    fill: var(--color-fg-on-emphasis);
    transition: visibility 0s linear 230ms;
    clip-path: inset(16px 0 0 0);

    @media screen and (prefers-reduced-motion: no-preference) {
      animation: checkmarkOut 220ms cubic-bezier(0.65, 0, 0.35, 1) forwards; // slightly snappier animation out
    }
  }

  .FormControl--checkbox-indeterminate {
    fill: transparent;
    visibility: hidden;
  }
}

@keyframes checkmarkIn {
  from {
    clip-path: inset(16px 0 0 0);
  }

  to {
    clip-path: inset(0 0 0 0);
  }
}

@keyframes checkmarkOut {
  from {
    clip-path: inset(0 0 0 0);
  }

  to {
    clip-path: inset(16px 0 0 0);
  }
}

@keyframes radioIn {
  from {
    clip-path: circle(0%);
  }

  to {
    clip-path: circle(100%);
  }
}

@keyframes radioOut {
  from {
    clip-path: circle(100%);
  }

  to {
    clip-path: circle(0%);
  }
}
